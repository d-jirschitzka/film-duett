<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film-Duett üé¨</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --gap: 12px; --radius: 12px; --shadow: 0 6px 24px rgba(0,0,0,.08); }
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      margin:0; padding:16px; max-width:980px; margin-inline:auto; line-height:1.45;
      background: canvas; color: CanvasText;
    }
    header { position: sticky; top: 0; z-index: 20; padding-top: 8px; margin-bottom: 12px; background: color-mix(in oklab, Canvas 94%, transparent); backdrop-filter: blur(6px); }
    h1 { font-size: 1.35rem; margin: 0 0 8px 0; }

    .card {
      background: canvas;
      border: 1px solid color-mix(in oklab, CanvasText 15%, Canvas 85%);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .row { display: grid; grid-template-columns: 1fr auto; gap: var(--gap); align-items: center; }
    .stack { display: grid; gap: var(--gap); }

    input, button, select {
      font: inherit; padding: 12px; border-radius: 12px;
      border: 1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%);
      background: canvas; color: CanvasText;
    }
    input { min-height: 44px; }
    button { cursor: pointer; border: none; box-shadow: var(--shadow); min-height: 44px; }
    button.primary { background: #3b82f6; color: #fff; }
    button.ghost { background: transparent; border: 1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%); box-shadow: none; }

    .muted { color: color-mix(in oklab, CanvasText 40%, Canvas 60%); }

    .film {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: start;
}

/* Left-Block (erstes Kind) zeigt Poster + Text nebeneinander */
.film > div:first-child {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  flex-wrap: wrap;          /* bricht auf kleineren Screens sauber um */
}

.film img {
  width: 72px;
  height: 108px;
  border-radius: 8px;
  object-fit: cover;
  flex: 0 0 auto;           /* Bild bleibt kompakt, zieht nichts breit */
}
    }
    .film h3 { margin: 0 0 4px 0; font-size: 1rem; word-break: break-word; }

    .meta {
      display: grid;
      grid-template-columns: repeat(3, max-content);
      gap: 8px 10px;
      align-items: center;
    }
    .meta .col {
      font-size: .85rem;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%);
      white-space: nowrap;
    }
    .meta .avail {
      grid-column: 1 / -1;
      font-size: .9rem;
      word-break: break-word;
    }

    .badges { display: inline-flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 6px; }
    .badge { font-size: .8rem; padding: 4px 8px; border-radius: 999px;
             border: 1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%); }
    a { color: inherit; text-decoration: none; }
    .link { color: #2563eb; text-decoration: underline; }

    .yesno { display: grid; gap: 8px; grid-auto-rows: minmax(44px, auto); }
    .pill { padding: 10px 12px; border-radius: 999px; background: color-mix(in oklab, #16a34a 18%, Canvas 82%); }
    .pill.no { background: color-mix(in oklab, #ef4444 18%, Canvas 82%); }

    .lists { display: grid; gap: var(--gap); }
    .list { display: grid; gap: 10px; }
    .divider { height: 1px; background: color-mix(in oklab, CanvasText 20%, Canvas 80%); margin: 6px 0; opacity:.5; }

    .topbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    .footer { margin-top: 24px; font-size: .85rem; color: color-mix(in oklab, CanvasText 45%, Canvas 55%); }

    /* Mobile-Optimierungen */
    @media (max-width: 680px) {
      body { padding: 12px; }
      .row { grid-template-columns: 1fr; }
      .film { grid-template-columns: 1fr; }
      .film img { width: 64px; height: 96px; }
      .yesno { grid-template-columns: 1fr 1fr; }
      .meta { grid-template-columns: 1fr 1fr; gap: 6px 8px; }
      .meta .col { font-size: .8rem; padding: 3px 6px; }
      .meta .avail { font-size: .85rem; }
      .badge { font-size: .78rem; }
    }
    @media (max-width: 420px) {
      .film { grid-template-columns: 1fr; }
      .film img { width: 88px; height: 132px; }
      .yesno { grid-template-columns: 1fr; }
      .badge { font-size: .76rem; }
      h1 { font-size: 1.2rem; }
    }

    #err { position:fixed; left:8px; right:8px; bottom:8px; padding:10px; border-radius:10px;
      background:#fee; border:1px solid #f99; color:#900; font:14px/1.3 system-ui; display:none; z-index:9999; }
  </style>
</head>
<body>
  <header>
    <h1>Film-Duett üé¨</h1>
    <div class="topbar card">
      <label>Ich bin:&nbsp;
        <select id="userSelect">
          <option value="David">David</option>
          <option value="Tim">Tim</option>
        </select>
      </label>
      <button class="ghost" id="shareBtn">Link teilen</button>
      <button class="ghost" id="pingBtn" title="Verbindung testen">Verbindung testen</button>
    </div>
  </header>

  <section class="card stack">
    <div class="row">
      <input id="titleInput" placeholder="Filmtitel eingeben ‚Ä¶" autocomplete="off" />
      <button id="addBtn" class="primary">Vorschlagen</button>
    </div>
    <div class="muted">
      Trailer, Jahr, L√§nge, Genre & Streaming (DE) werden automatisch gesucht. Eintragender stimmt automatisch ‚ÄûJa‚Äú.
    </div>
  </section>

  <section class="lists">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Beide einverstanden ‚úÖ</h2>
      <div id="confirmedList" class="list"></div>
    </div>
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Vorschl√§ge (noch offen) üìù</h2>
      <div id="proposedList" class="list"></div>
    </div>
  </section>

  <div class="footer">
    <span class="muted">Supabase (optional Realtime), TMDB f√ºr Trailer/Poster/Infos.</span>
  </div>

  <div id="err"></div>

  <!-- Supabase UMD (CORS an, Safari-freundlich) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>

  <script>
  /* ==== KEYS (deine sind hier eingetragen) ==== */
  const SUPABASE_URL = "https://iitbtkuezqahcpudtuac.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlpdGJ0a3VlenFhaGNwdWR0dWFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ0MjMsImV4cCI6MjA3MjQxMDQyM30.EepapVMgQC4HwE4LiFT4Xqge9KJPkl9oaVHsR3ERrms";
  const TMDB_KEY = "519d0298bfea17e42b5a258cde70b158";

  /* ==== UI-Refs ==== */
  var userSelect = document.getElementById("userSelect");
  var titleInput = document.getElementById("titleInput");
  var addBtn = document.getElementById("addBtn");
  var proposedList = document.getElementById("proposedList");
  var confirmedList = document.getElementById("confirmedList");
  var shareBtn = document.getElementById("shareBtn");
  var pingBtn = document.getElementById("pingBtn");
  var errBox = document.getElementById("err");

  function showErr(msg){
    console.error(msg);
    errBox.textContent = "Fehler: " + msg;
    errBox.style.display = "block";
  }
  function hideErr(){ errBox.style.display = "none"; }

  /* ==== Fehler-Handler (Safari zeigt sonst nur ‚ÄûScript error‚Äú) ==== */
  window.addEventListener("error", function (ev) {
    var msg = (ev && ev.message) ? ev.message : "Script error.";
    var loc = (ev && ev.filename) ? (" @ " + ev.filename + ":" + ev.lineno + ":" + ev.colno) : "";
    showErr(msg + loc);
  });
  window.addEventListener("unhandledrejection", function (ev) {
    var r = ev && ev.reason;
    var msg = (r && r.message) ? r.message : (r ? String(r) : "Unbekannter Promise-Fehler");
    showErr("Promise: " + msg);
  });

  /* ==== User aus ?user= laden ==== */
  var params = new URLSearchParams(location.search);
  var initialUser = params.get("user");
  if (initialUser) userSelect.value = initialUser;

  /* ==== Share-Link ==== */
  shareBtn.addEventListener("click", function(){
    var url = new URL(location.href);
    url.searchParams.set("user", userSelect.value);
    try {
      navigator.clipboard.writeText(url.toString()).then(function(){
        shareBtn.textContent = "Link kopiert ‚úÖ";
        setTimeout(function(){ shareBtn.textContent = "Link teilen"; }, 1500);
      });
    } catch(e) {
      prompt("Link kopieren:", url.toString());
    }
  });

  /* ==== Supabase Client ==== */
  var supabaseClient;
  function sb(){
    if (!window.supabase) { showErr("Supabase SDK nicht geladen"); throw new Error("supabase sdk missing"); }
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { showErr("Supabase Keys/URL fehlen"); throw new Error("keys missing"); }
    if (!supabaseClient) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return supabaseClient;
  }

  /* ==== TMDB ==== */
  function minutesToHM(mins){ if(!mins||isNaN(mins)) return "‚Äî"; var h=Math.floor(mins/60), m=mins%60; return h+"h "+m+"m"; }
  function providerNames(list){ if(!list||!list.length) return []; var map={}; for(var i=0;i<list.length;i++){ map[list[i].provider_id]=list[i].provider_name; } return Object.values(map).sort(); }
  async function tmdb(path){
    if (!TMDB_KEY) throw new Error("TMDB Key fehlt");
    var url = "https://api.themoviedb.org/3"+path+(path.indexOf("?")>-1?"&":"?")+"api_key="+TMDB_KEY;
    var res = await fetch(url);
    if (!res.ok) throw new Error("TMDB "+res.status);
    return res.json();
  }
  async function enrichMovieByTitle(title){
    var q = encodeURIComponent(title);
    var search = await tmdb("/search/movie?query="+q+"&include_adult=false&language=de-DE");
    if (!(search && search.results && search.results.length)) return null;
    var movie = search.results[0];

    var details = await tmdb("/movie/"+movie.id+"?language=de-DE");
    var year = (details && details.release_date) ? details.release_date.slice(0,4) : null;
    var runtime = details && details.runtime ? details.runtime : null;
    var genres = (details && details.genres) ? details.genres.map(function(g){return g.name;}).join(", ") : null;

    var vids = await tmdb("/movie/"+movie.id+"/videos?language=de-DE");
    var vr = (vids && vids.results) ? vids.results : [];
    var trailer = null;
    for (var i=0;i<vr.length;i++){ if (vr[i].type==="Trailer" && vr[i].site==="YouTube"){ trailer = vr[i]; break; } }
    if (!trailer) { for (var j=0;j<vr.length;j++){ if (vr[j].site==="YouTube"){ trailer = vr[j]; break; } } }
    var trailer_url = trailer ? ("https://www.youtube.com/watch?v="+trailer.key)
                              : ("https://www.youtube.com/results?search_query="+encodeURIComponent((details && details.title ? details.title : movie.title) + " Trailer"));

    var prov = await tmdb("/movie/"+movie.id+"/watch/providers");
    var de = (prov && prov.results && prov.results.DE) ? prov.results.DE : {};
    var flatrate = providerNames(de.flatrate || []);
    var rent = providerNames(de.rent || []);
    var buy = providerNames(de.buy || []);

    var poster_url = (movie && movie.poster_path) ? ("https://image.tmdb.org/t/p/w185"+movie.poster_path) : null;

    return {
      title: (details && details.title) ? details.title : movie.title,
      year: year,
      runtime: runtime,
      genres: genres,
      trailer_url: trailer_url,
      providers_flatrate: flatrate.join(", "),
      providers_rent: rent.join(", "),
      providers_buy: buy.join(", "),
      poster_url: poster_url
    };
  }

  /* ==== DB Ops ==== */
  async function addFilm(title, currentUser){
    hideErr();
    if (!title.trim()) return;
    addBtn.disabled = true; addBtn.textContent = "TMDB‚Ä¶";
    var info = null;
    try { info = await enrichMovieByTitle(title); } catch(e){ showErr("TMDB: "+(e.message||e)); }
    addBtn.textContent = "Supabase‚Ä¶";
    var base = {
      title: title.trim(),
      year: info && info.year ? info.year : null,
      runtime: info && info.runtime ? info.runtime : null,
      genres: info && info.genres ? info.genres : null,
      trailer_url: info && info.trailer_url ? info.trailer_url : null,
      providers_flatrate: info && info.providers_flatrate ? info.providers_flatrate : null,
      providers_rent: info && info.providers_rent ? info.providers_rent : null,
      providers_buy: info && info.providers_buy ? info.providers_buy : null,
      poster_url: info && info.poster_url ? info.poster_url : null,
      proposer: currentUser,
      yes_david: currentUser === "David" ? true : null,
      yes_tim:   currentUser === "Tim"   ? true : null
    };
    var ins = await sb().from("films").insert(base);
    addBtn.disabled = false; addBtn.textContent = "Vorschlagen"; titleInput.value = "";
    if (ins.error) showErr("Supabase insert: " + ins.error.message);
  }

  async function toggleVote(id, user, value){
    hideErr();
    var patch = user === "David" ? { yes_david: value } : { yes_tim: value };
    var upd = await sb().from("films").update(patch).eq("id", id);
    if (upd.error) showErr("Supabase update: " + upd.error.message);
  }

  async function loadFilms(){
    hideErr();
    var res = await sb().from("films").select("*").order("created_at",{ascending:false});
    if (res.error) { showErr("Supabase select: " + res.error.message); return; }
    renderLists(res.data || []);
  }

  /* ==== Realtime (optional) ==== */
  try {
    sb().channel("films-changes")
      .on("postgres_changes", { event:"*", schema:"public", table:"films" }, loadFilms)
      .subscribe();
  } catch (e) { /* egal, wenn nicht aktiv */ }

  /* ==== UI ==== */
  function filmItem(f){
    var me = userSelect.value;
    var myKey = me === "David" ? "yes_david" : "yes_tim";
    var otherName = me === "David" ? "Tim" : "David";
    var otherKey = otherName === "David" ? "yes_david" : "yes_tim";

    var myVal = f[myKey];       // true | false | null
    var otherVal = f[otherKey]; // true | false | null

    var wrapper = document.createElement("div");
    wrapper.className = "film";
    wrapper.dataset.id = f.id;

    // Linke Spalte
    var left = document.createElement("div");
    if (f.poster_url) {
      var img = document.createElement("img");
      img.src = f.poster_url; img.alt = f.title;
      left.appendChild(img);
    }

    var h3 = document.createElement("h3");
    h3.textContent = f.title + (f.year ? " ("+f.year+")" : "");
    left.appendChild(h3);

    var meta = document.createElement("div"); meta.className = "meta";
    var colLen = document.createElement("div"); colLen.className="col"; colLen.textContent = f.runtime ? minutesToHM(f.runtime) : "‚Äî";
    var colGenre = document.createElement("div"); colGenre.className="col"; colGenre.textContent = f.genres || "‚Äî";
    var colYear = document.createElement("div"); colYear.className="col"; colYear.textContent = f.year || "‚Äî";
    var avail = document.createElement("div"); avail.className = "avail muted";

    var fl = f.providers_flatrate ? f.providers_flatrate.split(",").map(function(s){return s.trim();}).filter(Boolean) : [];
    var rn = f.providers_rent ? f.providers_rent.split(",").map(function(s){return s.trim();}).filter(Boolean) : [];
    var by = f.providers_buy ? f.providers_buy.split(",").map(function(s){return s.trim();}).filter(Boolean) : [];

    if (fl.length) {
      avail.innerHTML = 'Streaming (DE): <strong>Flatrate:</strong> ' + fl.join(", ") + ((rn.length||by.length)?' ¬∑ ':'');
      if (rn.length) avail.innerHTML += '<strong>Leihen:</strong> ' + rn.join(", ") + (by.length?' ¬∑ ':'');
      if (by.length) avail.innerHTML += '<strong>Kaufen:</strong> ' + by.join(", ");
    } else if (rn.length || by.length) {
      avail.innerHTML = 'Kein Abo-Streaming (DE). ' + (rn.length?'<strong>Leihen:</strong> '+rn.join(", "):'') + ((rn.length&&by.length)?' ¬∑ ':'') + (by.length?'<strong>Kaufen:</strong> '+by.join(", "):'');
    } else {
      avail.innerHTML = 'Nicht bei deutschen Diensten gelistet ‚Üí <strong>DVD/Blu-ray</strong> einplanen.';
    }

    meta.appendChild(colLen); meta.appendChild(colGenre); meta.appendChild(colYear); meta.appendChild(avail);

    var badges = document.createElement("div"); badges.className = "badges";
    if (f.trailer_url) { var a=document.createElement("a"); a.className="badge link"; a.href=f.trailer_url; a.target="_blank"; a.rel="noopener"; a.textContent="Trailer ‚ñ∂"; badges.appendChild(a); }
    var p=document.createElement("span"); p.className="badge"; p.textContent="Vorgeschlagen von: "+f.proposer; badges.appendChild(p);

    var status=document.createElement("span"); status.className="badge";
    if (otherVal === null) { status.style.borderColor = "#f59e0b"; status.textContent = otherName + ": wartet ‚Ä¶"; }
    else if (otherVal === false) { status.style.borderColor = "#ef4444"; status.textContent = otherName + ": Nein"; }
    else { status.style.borderColor = "#16a34a"; status.textContent = otherName + ": Ja"; }
    badges.appendChild(status);

    left.appendChild(meta); left.appendChild(badges);

    // Rechte Spalte (Buttons)
    var actions = document.createElement("div"); actions.className = "yesno";

    var meBtn = document.createElement("button");
    function setMeBtn(val){ meBtn.className = "pill" + (val ? "" : " no"); meBtn.textContent = me + (val ? " ‚úî" : " ‚úñ"); }
    setMeBtn(!!myVal);
    meBtn.title = "Deine Stimme umschalten";
    meBtn.onclick = function(){
      var newVal = !(!!(f[myKey])); // true -> false, false/null -> true
      var oldVal = f[myKey];
      f[myKey] = newVal; setMeBtn(newVal); // Optimistic UI
      sb().from("films").update((function(){ var o={}; o[myKey]=newVal; return o; })()).eq("id", f.id)
      .then(function(res){
        if (res.error){ f[myKey] = oldVal; setMeBtn(!!oldVal); showErr("Supabase update: " + res.error.message); }
        else { moveItemOptimistically(f.id, newVal, f[otherKey] === true); }
      })
      .catch(function(e){ f[myKey] = oldVal; setMeBtn(!!oldVal); showErr(e.message||e); });
    };

    var otherBtn = document.createElement("button");
    otherBtn.className = "pill" + (otherVal ? "" : " no");
    otherBtn.textContent = otherName + (otherVal ? " ‚úî" : (otherVal === false ? " ‚úñ" : " ‚Ä¶"));
    otherBtn.disabled = true;
    otherBtn.title = "Wird vom anderen best√§tigt";

    var delBtn = document.createElement("button");
    delBtn.className = "pill no"; delBtn.textContent = "L√∂schen üóë"; delBtn.title = "Diesen Film l√∂schen";
    delBtn.onclick = function(){
      if (!confirm('Wirklich l√∂schen: "'+f.title+'"?')) return;
      var parent = wrapper.parentElement;
      var divider = (wrapper.nextElementSibling && wrapper.nextElementSibling.classList.contains("divider")) ? wrapper.nextElementSibling : null;
      wrapper.remove(); if (divider) divider.remove();
      sb().from("films").delete().eq("id", f.id).then(function(res){
        if (res.error){ showErr("Supabase delete: " + res.error.message); if(parent){ parent.appendChild(wrapper); if(divider) parent.appendChild(divider); } }
      }).catch(function(e){ showErr(e.message||e); if(parent){ parent.appendChild(wrapper); if(divider) parent.appendChild(divider); } });
    };

    actions.appendChild(meBtn); actions.appendChild(otherBtn); actions.appendChild(delBtn);

    wrapper.appendChild(left); wrapper.appendChild(actions);
    return wrapper;
  }

  function moveItemOptimistically(id, myNowTrue, otherAlreadyTrue){
    var node = document.querySelector('.film[data-id="'+id+'"]');
    if (!node) return;
    var goConfirmed = otherAlreadyTrue && myNowTrue;
    var target = goConfirmed ? confirmedList : proposedList;
    if (node.parentElement === target) return;
    var divider = node.nextElementSibling && node.nextElementSibling.classList.contains("divider") ? node.nextElementSibling : null;
    node.remove(); if (divider) divider.remove();
    target.appendChild(node);
    var div = document.createElement("div"); div.className = "divider"; target.appendChild(div);
  }

  function renderLists(all){
    proposedList.innerHTML = ""; confirmedList.innerHTML = "";
    var confirmed = all.filter(function(f){ return f.yes_david === true && f.yes_tim === true; });
    var proposed  = all.filter(function(f){ return !(f.yes_david === true && f.yes_tim === true); });
    for (var i=0;i<confirmed.length;i++){ confirmedList.appendChild(filmItem(confirmed[i])); var d1=document.createElement("div"); d1.className="divider"; confirmedList.appendChild(d1); }
    for (var j=0;j<proposed.length;j++){ proposedList.appendChild(filmItem(proposed[j])); var d2=document.createElement("div"); d2.className="divider"; proposedList.appendChild(d2); }
  }

  addBtn.addEventListener("click", function(){ addFilm(titleInput.value, userSelect.value); });
  titleInput.addEventListener("keydown", function(e){ if(e.key==="Enter") addFilm(titleInput.value, userSelect.value); });

  pingBtn.addEventListener("click", function(){
    hideErr();
    sb().from("films").select("id").limit(1).then(function(res){
      if (res.error) showErr("Supabase select: " + res.error.message);
      else { pingBtn.textContent = "OK ‚úÖ"; setTimeout(function(){ pingBtn.textContent="Verbindung testen"; }, 1500); }
    }).catch(function(e){ showErr(e.message||e); });
  });

  // Initial load
  (function(){ loadFilms().catch(function(e){ showErr(e.message||e); }); })();
  </script>
</body>
</html>
