<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film-Duett üé¨</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --gap: 12px; --radius: 12px; --shadow: 0 6px 24px rgba(0,0,0,.08); }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      margin:0; padding:20px; max-width:980px; margin-inline:auto; line-height:1.4; }
    header { display:flex; align-items:center; justify-content:space-between; gap:var(--gap); margin-bottom:16px; }
    h1 { font-size:1.4rem; margin:0; }
    .card { background: canvas; border:1px solid color-mix(in oklab, CanvasText 15%, Canvas 85%);
      border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); }
    .row { display:grid; grid-template-columns:1fr auto; gap:var(--gap); }
    .stack { display:grid; gap:var(--gap); }
    input, button, select { font:inherit; padding:10px 12px; border-radius:10px;
      border:1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%); background:canvas; color:CanvasText; }
    button { cursor:pointer; border:none; box-shadow:var(--shadow); }
    button.primary { background:#3b82f6; color:#fff; }
    button.ghost { background:transparent; border:1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%); box-shadow:none; }
    .muted { color: color-mix(in oklab, CanvasText 40%, Canvas 60%); }
    .film { display:grid; gap:6px; grid-template-columns:1fr auto; align-items:start; }
    .film h3 { margin:0; font-size:1rem; }
    .meta { display:grid; grid-template-columns:repeat(3,max-content) 1fr; gap:8px 12px; align-items:center; }
    .meta .col { font-size:.85rem; padding:4px 8px; border-radius:8px;
                 border:1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%); }
    .meta .avail { grid-column:1/-1; font-size:.9rem; }
    .badges { display:inline-flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .badge { font-size:.8rem; padding:4px 8px; border-radius:999px;
             border:1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%); }
    .yesno { display:inline-flex; gap:6px; align-items:center; }
    .pill { padding:6px 10px; border-radius:999px; background: color-mix(in oklab, #16a34a 18%, Canvas 82%); }
    .pill.no { background: color-mix(in oklab, #ef4444 18%, Canvas 82%); }
    .lists { display:grid; gap:var(--gap); }
    .list { display:grid; gap:10px; }
    a { color:inherit; text-decoration:none; }
    .link { color:#2563eb; text-decoration:underline; }
    .divider { height:1px; background: color-mix(in oklab, CanvasText 20%, Canvas 80%); margin:6px 0; opacity:.5; }
    .topbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .footer { margin-top:24px; font-size:.85rem; color: color-mix(in oklab, CanvasText 45%, Canvas 55%); }
    #err { position:fixed; left:8px; right:8px; bottom:8px; padding:10px; border-radius:10px;
      background:#fee; border:1px solid #f99; color:#900; font:14px/1.3 system-ui; display:none; z-index:9999; }
    @media (max-width:640px){ .row{grid-template-columns:1fr} .film{grid-template-columns:1fr} .meta{grid-template-columns:repeat(3,max-content)} }
  </style>
</head>
<body>
  <header>
    <h1>Film-Duett üé¨</h1>
    <div class="topbar card">
      <label>Ich bin:&nbsp;
        <select id="userSelect">
          <option value="David">David</option>
          <option value="Tim">Tim</option>
        </select>
      </label>
      <button class="ghost" id="shareBtn">Link teilen</button>
      <button class="ghost" id="pingBtn" title="Verbindung testen">Verbindung testen</button>
    </div>
  </header>

  <section class="card stack">
    <div class="row">
      <input id="titleInput" placeholder="Filmtitel eingeben ‚Ä¶" autocomplete="off" />
      <button id="addBtn" class="primary">Vorschlagen</button>
    </div>
    <div class="muted">
      Tipp: Nur Titel eintippen. Trailer, Jahr, L√§nge, Genre & Streaming (DE) werden automatisch gesucht.
      Der Eintragende stimmt automatisch mit ‚ÄûJa‚Äú.
    </div>
  </section>

  <section class="lists">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Beide einverstanden ‚úÖ</h2>
      <div id="confirmedList" class="list"></div>
    </div>
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Vorschl√§ge (noch offen) üìù</h2>
      <div id="proposedList" class="list"></div>
    </div>
  </section>

  <div class="footer">
    <span class="muted">Einfach. Mobilfreundlich. Realtime-Sync via Supabase. Trailer & Streaming via TMDB.</span>
  </div>

  <div id="err"></div>

  <!-- UMD Builds: Stabil, kein Module-Import n√∂tig -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" ></script>
  <script defer>
  // === KEYS EINTRAGEN ===
  const SUPABASE_URL = "https://iitbtkuezqahcpudtuac.supabase.co";           // z.B. https://xyzcompany.supabase.co
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlpdGJ0a3VlenFhaGNwdWR0dWFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ0MjMsImV4cCI6MjA3MjQxMDQyM30.EepapVMgQC4HwE4LiFT4Xqge9KJPkl9oaVHsR3ERrms";  // beginnt meist mit eyJ...
  const TMDB_KEY = "519d0298bfea17e42b5a258cde70b158";

  // === UI-Refs ===
  const userSelect = document.getElementById("userSelect");
  const titleInput = document.getElementById("titleInput");
  const addBtn = document.getElementById("addBtn");
  const proposedList = document.getElementById("proposedList");
  const confirmedList = document.getElementById("confirmedList");
  const shareBtn = document.getElementById("shareBtn");
  const pingBtn = document.getElementById("pingBtn");
  const errBox = document.getElementById("err");

  // Start verz√∂gern, bis window.supabase da ist
if (!window.supabase) {
  const wait = () => {
    if (window.supabase) return; 
    setTimeout(wait, 50);
  };
  wait();
}

  function showErr(msg){ console.error(msg); errBox.textContent = "Fehler: " + msg; errBox.style.display = "block"; }
  function hideErr(){ errBox.style.display = "none"; }

  // Name aus URL ?user=David|Tim laden
  const params = new URLSearchParams(location.search);
  const initialUser = params.get("user");
  if (initialUser) userSelect.value = initialUser;

  shareBtn.addEventListener("click", async () => {
    const url = new URL(location.href);
    url.searchParams.set("user", userSelect.value);
    try { await navigator.clipboard.writeText(url.toString());
      shareBtn.textContent = "Link kopiert ‚úÖ"; setTimeout(()=>shareBtn.textContent="Link teilen",1500);
    } catch { prompt("Link kopieren:", url.toString()); }
  });

  window.addEventListener("error", (ev)=>showErr(ev.message));
  window.addEventListener("unhandledrejection", (ev)=>showErr(ev.reason?.message || ev.reason || "Unbekannter Fehler"));

  // === Supabase Client ===
  let supabaseClient;
  function sb(){ 
    if (!window.supabase) { showErr("Supabase SDK nicht geladen"); throw new Error("supabase sdk missing"); }
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("DEINE_")) { 
      showErr("Supabase Keys/URL fehlen"); throw new Error("keys missing"); 
    }
    if (!supabaseClient) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return supabaseClient;
  }

  // === TMDB Helpers ===
  async function tmdb(path) {
    if (!TMDB_KEY || TMDB_KEY.includes("DEIN_TMDB")) throw new Error("TMDB Key fehlt");
    const res = await fetch(`https://api.themoviedb.org/3${path}${path.includes("?")?"&":"?"}api_key=${TMDB_KEY}`);
    if (!res.ok) throw new Error("TMDB " + res.status);
    return res.json();
  }
  function minutesToHM(mins){ if(!mins||isNaN(mins)) return "‚Äî"; const h=Math.floor(mins/60), m=mins%60; return `${h}h ${m}m`; }
  function providerNames(list){ if(!Array.isArray(list)||!list.length) return []; const map=new Map(); for(const p of list) map.set(p.provider_id,p.provider_name); return Array.from(map.values()).sort(); }

  async function enrichMovieByTitle(title){
    const q = encodeURIComponent(title);
    const search = await tmdb(`/search/movie?query=${q}&include_adult=false&language=de-DE`);
    if (!search.results?.length) return null;
    const movie = search.results[0];
    const details = await tmdb(`/movie/${movie.id}?language=de-DE`);
    const year = (details.release_date||"").slice(0,4) || null;
    const runtime = details.runtime || null;
    const genres = (details.genres||[]).map(g=>g.name).join(", ") || null;
    const vids = await tmdb(`/movie/${movie.id}/videos?language=de-DE`);
    const trailer = (vids.results||[]).find(v=>v.type==="Trailer" && v.site==="YouTube") || (vids.results||[]).find(v=>v.site==="YouTube");
    const trailer_url = trailer ? `https://www.youtube.com/watch?v=${trailer.key}`
                                : `https://www.youtube.com/results?search_query=${encodeURIComponent(details.title+' Trailer')}`;
    const prov = await tmdb(`/movie/${movie.id}/watch/providers`);
    const de = prov.results?.DE || {};
    const flatrate = providerNames(de.flatrate);
    const rent = providerNames(de.rent);
    const buy = providerNames(de.buy);

    return { title: details.title || movie.title, year, runtime, genres, trailer_url,
      providers_flatrate: flatrate.join(", "), providers_rent: rent.join(", "), providers_buy: buy.join(", ") };
  }

  // === DB Ops ===
  async function addFilm(title, currentUser){
    hideErr();
    if (!title.trim()) return;
    addBtn.disabled = true; addBtn.textContent = "TMDB‚Ä¶";
    const info = await enrichMovieByTitle(title).catch(e => (showErr("TMDB: "+e.message), null));
    addBtn.textContent = "Supabase‚Ä¶";
    const base = {
      title: title.trim(),
      year: info?.year || null,
      runtime: info?.runtime || null,
      genres: info?.genres || null,
      trailer_url: info?.trailer_url || null,
      providers_flatrate: info?.providers_flatrate || null,
      providers_rent: info?.providers_rent || null,
      providers_buy: info?.providers_buy || null,
      proposer: currentUser,
      yes_david: currentUser === "David" ? true : null,
      yes_tim:   currentUser === "Tim"   ? true : null
    };
    const { error } = await sb().from("films").insert(base);
    addBtn.disabled = false; addBtn.textContent = "Vorschlagen"; titleInput.value = "";
    if (error) showErr("Supabase insert: " + error.message);
  }

  async function toggleVote(id, user, value){
    hideErr();
    const patch = user === "David" ? { yes_david: value } : { yes_tim: value };
    const { error } = await sb().from("films").update(patch).eq("id", id);
    if (error) showErr("Supabase update: " + error.message);
  }

  async function loadFilms(){
    hideErr();
    const { data, error } = await sb().from("films").select("*").order("created_at",{ascending:false});
    if (error) { showErr("Supabase select: " + error.message); return; }
    renderLists(data || []);
  }

  // Realtime (optional ‚Äì erst aktiv, wenn in Supabase unter Database‚ÜíReplication‚ÜíRealtime f√ºr Tabelle films eingeschaltet)
  try {
    sb().channel("films-changes")
      .on("postgres_changes", { event:"*", schema:"public", table:"films" }, loadFilms)
      .subscribe();
  } catch (e) { /* wenn Realtime noch aus ist, egal */ }

  function filmItem(f){
  const me = userSelect.value;
  const myKey = me === "David" ? "yes_david" : "yes_tim";
  const otherName = me === "David" ? "Tim" : "David";
  const otherKey = otherName === "David" ? "yes_david" : "yes_tim";

  const myVal = f[myKey];       // true | false | null
  const otherVal = f[otherKey]; // true | false | null

  const wrapper = document.createElement("div");
  wrapper.className = "film";
  wrapper.dataset.id = f.id;

  // Titel
  const left = document.createElement("div");
  const h3 = document.createElement("h3");
  h3.textContent = f.title + (f.year ? ` (${f.year})` : "");
  left.appendChild(h3);

  // Meta (L√§nge/Genre/Jahr + Verf√ºgbarkeit)
  const meta = document.createElement("div"); meta.className = "meta";
  const colLen = document.createElement("div"); colLen.className="col"; colLen.textContent = f.runtime ? minutesToHM(f.runtime) : "‚Äî";
  const colGenre = document.createElement("div"); colGenre.className="col"; colGenre.textContent = f.genres || "‚Äî";
  const colYear = document.createElement("div"); colYear.className="col"; colYear.textContent = f.year || "‚Äî";
  const avail = document.createElement("div"); avail.className = "avail muted";

  const fl = f.providers_flatrate ? f.providers_flatrate.split(",").map(s=>s.trim()).filter(Boolean) : [];
  const rn = f.providers_rent ? f.providers_rent.split(",").map(s=>s.trim()).filter(Boolean) : [];
  const by = f.providers_buy ? f.providers_buy.split(",").map(s=>s.trim()).filter(Boolean) : [];

  if (fl.length) {
    avail.innerHTML = `Streaming (DE): <strong>Flatrate:</strong> ${fl.join(", ")}${rn.length||by.length? " ¬∑ " : ""}`;
    if (rn.length) avail.innerHTML += `<strong>Leihen:</strong> ${rn.join(", ")}${by.length? " ¬∑ " : ""}`;
    if (by.length) avail.innerHTML += `<strong>Kaufen:</strong> ${by.join(", ")}`;
  } else if (rn.length || by.length) {
    avail.innerHTML = `Kein Abo-Streaming (DE). ${rn.length? "<strong>Leihen:</strong> "+rn.join(", ") : ""}${(rn.length&&by.length)?" ¬∑ ":""}${by.length? "<strong>Kaufen:</strong> "+by.join(", ") : ""}`;
  } else {
    avail.innerHTML = `Nicht bei deutschen Diensten gelistet ‚Üí <strong>DVD/Blu-ray</strong> einplanen.`;
  }

  meta.append(colLen, colGenre, colYear, avail);

  // Badges (Trailer + vorgeschlagen von + Status vom anderen)
  const badges = document.createElement("div"); badges.className = "badges";
  if (f.trailer_url) {
    const a = document.createElement("a");
    a.className = "badge link"; a.href = f.trailer_url; a.target = "_blank"; a.rel = "noopener";
    a.textContent = "Trailer ‚ñ∂";
    badges.appendChild(a);
  }
  const p = document.createElement("span"); p.className = "badge"; p.textContent = "Vorgeschlagen von: " + f.proposer;
  badges.appendChild(p);

  // Status-Badge (anderer)
  const status = document.createElement("span");
  status.className = "badge";
  if (otherVal === null) { status.style.borderColor = "#f59e0b"; status.textContent = `${otherName}: wartet ‚Ä¶`; }
  else if (otherVal === false) { status.style.borderColor = "#ef4444"; status.textContent = `${otherName}: Nein`; }
  else { status.style.borderColor = "#16a34a"; status.textContent = `${otherName}: Ja`; }
  badges.appendChild(status);

  left.append(meta, badges);

  // Rechte Seite (Buttons)
  const actions = document.createElement("div"); actions.className = "yesno";

  // Mein Button (optimistic toggle)
  const meBtn = document.createElement("button");
  const setMeBtn = (val) => {
    meBtn.className = "pill" + (val ? "" : " no");
    meBtn.textContent = me + (val ? " ‚úî" : " ‚úñ");
  };
  setMeBtn(!!myVal); // null -> rot (‚úñ) als ‚Äûnoch nicht best√§tigt/kein Ja‚Äú

  meBtn.title = "Deine Stimme umschalten";
  meBtn.onclick = async () => {
    const newVal = !(!!(f[myKey])); // true -> false, false/null -> true
    const oldVal = f[myKey];
    // Optimistic UI
    f[myKey] = newVal; setMeBtn(newVal);
    try {
      const { error } = await sb().from("films").update({ [myKey]: newVal }).eq("id", f.id);
      if (error) { f[myKey] = oldVal; setMeBtn(!!oldVal); showErr("Supabase update: " + error.message); }
      else {
        moveItemOptimistically(f.id, newVal, f[otherKey] === true);
      }
    } catch (e) { f[myKey] = oldVal; setMeBtn(!!oldVal); showErr(e.message||e); }
  };

  // Anderer (nur Anzeige)
  const otherBtn = document.createElement("button");
  otherBtn.className = "pill" + (otherVal ? "" : " no");
  otherBtn.textContent = otherName + (otherVal ? " ‚úî" : (otherVal === false ? " ‚úñ" : " ‚Ä¶"));
  otherBtn.disabled = true;
  otherBtn.title = "Wird vom anderen best√§tigt";

  // Delete-Button mit Best√§tigung & Optimistic Remove
  const delBtn = document.createElement("button");
  delBtn.className = "pill no";
  delBtn.textContent = "L√∂schen üóë";
  delBtn.title = "Diesen Film l√∂schen";
  delBtn.onclick = async () => {
    if (!confirm(`Wirklich l√∂schen: "${f.title}"?`)) return;
    const parent = wrapper.parentElement;
    const divider = wrapper.nextElementSibling && wrapper.nextElementSibling.classList.contains("divider") ? wrapper.nextElementSibling : null;
    wrapper.remove(); if (divider) divider.remove();
    try {
      const { error } = await sb().from("films").delete().eq("id", f.id);
      if (error) { showErr("Supabase delete: " + error.message); parent && parent.appendChild(wrapper); if (divider) parent.appendChild(divider); }
    } catch (e) { showErr(e.message||e); parent && parent.appendChild(wrapper); if (divider) parent.appendChild(divider); }
  };

  actions.append(meBtn, otherBtn, delBtn);
  wrapper.append(left, actions);
  return wrapper;
}

  function renderLists(all){
    proposedList.innerHTML = ""; confirmedList.innerHTML = "";
    const confirmed = all.filter(f => f.yes_david === true && f.yes_tim === true);
    const proposed  = all.filter(f => !(f.yes_david === true && f.yes_tim === true));
    for (const f of confirmed){ confirmedList.appendChild(filmItem(f)); const div=document.createElement("div"); div.className="divider"; confirmedList.appendChild(div); }
    for (const f of proposed){ proposedList.appendChild(filmItem(f)); const div=document.createElement("div"); div.className="divider"; proposedList.appendChild(div); }
  }

  addBtn.addEventListener("click", () => addFilm(titleInput.value, userSelect.value));
  titleInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addFilm(titleInput.value, userSelect.value); });

  pingBtn.addEventListener("click", async ()=>{
    try{
      hideErr();
      if (!sb()) return;
      const { error } = await sb().from("films").select("id").limit(1);
      if (error) showErr("Supabase select: " + error.message);
      else { pingBtn.textContent = "OK ‚úÖ"; setTimeout(()=>pingBtn.textContent="Verbindung testen", 1500); }
    } catch(e){ showErr(e.message||e); }
  });

  // ‚Üê HIER direkt darunter die Funktion global einf√ºgen:
  function moveItemOptimistically(id, myNowTrue, otherAlreadyTrue){
    const node = document.querySelector(`.film[data-id="${id}"]`);
    if (!node) return;
    const goConfirmed = otherAlreadyTrue && myNowTrue;
    const target = goConfirmed ? confirmedList : proposedList;
    if (node.parentElement === target) return;
    const divider = node.nextElementSibling && node.nextElementSibling.classList.contains("divider")
      ? node.nextElementSibling : null;
    node.remove(); if (divider) divider.remove();
    target.appendChild(node);
    const div = document.createElement("div"); div.className = "divider"; target.appendChild(div);
  }

  // Initial load
  (async ()=>{ try{ await loadFilms(); }catch(e){ showErr(e.message||e); }})();
  </script>
</body>
</html>


